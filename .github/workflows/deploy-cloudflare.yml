# GitHub Actions workflow for Cloudflare Pages & Workers deployment
# This workflow deploys the frontend to Cloudflare Pages and the API to Cloudflare Workers

name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Prevent concurrent deployments to the same environment
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Job: Determine deployment environment
  # ============================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # Manual trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Push to main = production
          elif [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Push to develop = staging
          elif [ "${{ github.ref }}" = "refs/heads/develop" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # PR = staging (for preview)
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Job: Lint and Type Check
  # ============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            workers/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install workers dependencies
        working-directory: workers
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: npm run lint || true

      - name: Type check frontend
        working-directory: frontend
        run: npm run typecheck || true

      - name: Type check workers
        working-directory: workers
        run: npm run typecheck

  # ============================================================================
  # Job: Test Workers
  # ============================================================================
  test-workers:
    name: Test Workers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: workers/package-lock.json

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Run tests
        working-directory: workers
        run: npm run test:run
        env:
          CI: true

  # ============================================================================
  # Job: Test Frontend
  # ============================================================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        working-directory: frontend
        run: npm run test:run || true
        env:
          CI: true

  # ============================================================================
  # Job: Build Frontend
  # ============================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [lint, test-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # ============================================================================
  # Job: Deploy Workers to Cloudflare
  # ============================================================================
  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: [setup, lint, test-workers]
    if: needs.setup.outputs.should_deploy == 'true'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ needs.setup.outputs.environment == 'production' && 'https://api.grubtech.com' || 'https://grubtech-api-staging.workers.dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: workers/package-lock.json

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Run D1 migrations (Staging)
        if: needs.setup.outputs.environment == 'staging'
        working-directory: workers
        run: |
          npx wrangler d1 migrations apply grubtech-staging --env staging --remote
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Run D1 migrations (Production)
        if: needs.setup.outputs.environment == 'production'
        working-directory: workers
        run: |
          npx wrangler d1 migrations apply grubtech-production --remote
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy Workers (Staging)
        if: needs.setup.outputs.environment == 'staging'
        working-directory: workers
        run: |
          npx wrangler deploy --env staging
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy Workers (Production)
        if: needs.setup.outputs.environment == 'production'
        working-directory: workers
        run: |
          npx wrangler deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 5
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            curl -f https://grubtech-api.workers.dev/api/health || echo "Health check pending DNS propagation"
          else
            curl -f https://grubtech-api-staging.workers.dev/api/health || echo "Health check pending DNS propagation"
          fi

  # ============================================================================
  # Job: Deploy Pages to Cloudflare
  # ============================================================================
  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: [setup, build-frontend]
    if: needs.setup.outputs.should_deploy == 'true'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ needs.setup.outputs.environment == 'production' && 'https://grubtech.com' || 'https://staging.grubtech-website.pages.dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install wrangler
        run: npm install -g wrangler@latest

      - name: Deploy to Cloudflare Pages (Staging)
        if: needs.setup.outputs.environment == 'staging'
        run: |
          npx wrangler pages deploy frontend/dist \
            --project-name=grubtech-website \
            --branch=staging \
            --commit-hash=${{ github.sha }}
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Pages (Production)
        if: needs.setup.outputs.environment == 'production'
        run: |
          npx wrangler pages deploy frontend/dist \
            --project-name=grubtech-website \
            --branch=main \
            --commit-hash=${{ github.sha }}
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Output deployment URL
        run: |
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            echo "Deployed to: https://grubtech-website.pages.dev"
          else
            echo "Deployed to: https://staging.grubtech-website.pages.dev"
          fi

  # ============================================================================
  # Job: Post-deployment verification
  # ============================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [setup, deploy-workers, deploy-pages]
    if: needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: Wait for propagation
        run: sleep 30

      - name: Check Workers health
        run: |
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            WORKERS_URL="https://grubtech-api.workers.dev/api/health"
          else
            WORKERS_URL="https://grubtech-api-staging.workers.dev/api/health"
          fi

          echo "Checking Workers health at: $WORKERS_URL"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$WORKERS_URL" || echo "000")

          if [ "$response" = "200" ]; then
            echo "Workers health check passed!"
          else
            echo "Workers health check returned: $response (may need DNS propagation)"
          fi

      - name: Check Pages accessibility
        run: |
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            PAGES_URL="https://grubtech-website.pages.dev"
          else
            PAGES_URL="https://staging.grubtech-website.pages.dev"
          fi

          echo "Checking Pages at: $PAGES_URL"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PAGES_URL" || echo "000")

          if [ "$response" = "200" ]; then
            echo "Pages deployment verified!"
          else
            echo "Pages returned: $response (may need DNS propagation)"
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            echo "**Workers API:** https://grubtech-api.workers.dev" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend:** https://grubtech-website.pages.dev" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Workers API:** https://grubtech-api-staging.workers.dev" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend:** https://staging.grubtech-website.pages.dev" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Job: Notify on failure
  # ============================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-workers, deploy-pages]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
